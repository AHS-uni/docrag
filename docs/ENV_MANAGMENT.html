<h1 id="docrag-environmentmanagement-guide">DocRAG —
Environment‑Management Guide</h1>
<p><em>Everything you need to spin‑up and maintain a working env, even
if you’ve never touched the codebase before.</em> <em>Last updated —
27 May 2025</em></p>
<hr />
<h2 id="project-details">1  Project details</h2>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 76%" />
</colgroup>
<thead>
<tr class="header">
<th>Item</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Python version</strong></td>
<td> 3.12 or newer</td>
</tr>
<tr class="even">
<td><strong>Platforms we target</strong></td>
<td>• Laptop/CI <strong>CPU</strong> env  <br>• Rental
<strong>GPU</strong> box (CUDA 12.4)</td>
</tr>
<tr class="odd">
<td><strong>Primary GPU images</strong></td>
<td>A40 · RTX A6000 · RTX 4090 (driver ≥ 550)</td>
</tr>
<tr class="even">
<td><strong>Env managers</strong></td>
<td><em>Conda</em> (for compiled/CUDA libs) + <em>Poetry</em> (for
pure‑Python &amp; lock‑file)</td>
</tr>
</tbody>
</table>
<h3 id="prerequisites">Prerequisites</h3>
<ol type="1">
<li><strong>Conda / Mamba</strong> installed (<a
href="https://docs.conda.io">https://docs.conda.io</a>).</li>
<li><strong>Poetry</strong> installed (<a
href="https://python-poetry.org/docs/#installation">https://python-poetry.org/docs/#installation</a>).</li>
</ol>
<hr />
<h2 id="environmentrelated-files">2  Environment‑related files</h2>
<h3 id="environment-related-files">Environment-Related Files</h3>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 87%" />
</colgroup>
<thead>
<tr class="header">
<th><strong>File</strong></th>
<th><strong>What it defines</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>environment-cpu.yml</code></td>
<td>Defines the Conda environment <code>docrag-cpu</code>, used for
development and testing on CPU machines. Installs CPU-only versions of
heavy libraries like PyTorch (<code>pytorch=2.6.0</code>) and Faiss
(<code>faiss-cpu=1.11.0</code>), along with notebook tools.</td>
</tr>
<tr class="even">
<td><code>environment-gpu.yml</code></td>
<td>Defines the Conda environment <code>docrag-gpu</code>, targeting GPU
machines with CUDA 12.4. Installs <code>torch==2.6.0+cu124</code>,
<code>faiss-gpu-cuvs=1.11.0</code>, <code>pytorch-cuda=12.4</code>, and
other CUDA-linked libraries. Uses both Conda and pip to install
GPU-compatible wheels.</td>
</tr>
<tr class="odd">
<td><code>pyproject.toml</code></td>
<td>Defines the project metadata, Python version
(<code>&gt;=3.12</code>), and all <strong>pure-Python</strong> runtime
and dev dependencies. Poetry uses this to manage the environment’s
Python packages. Conda is not involved here.</td>
</tr>
<tr class="even">
<td><code>poetry.lock</code></td>
<td>Stores the exact resolved versions of every package listed in
<code>pyproject.toml</code>. Ensures consistent environments across
machines. Never edit this file manually—Poetry generates it.</td>
</tr>
</tbody>
</table>
<p>You probably won’t need to interact with these files directly but
it’s useful to know what they contain. Refer to the <a
href="https://python-poetry.org/docs/pyproject/">Poetry ‘pyproject.toml’
documentation</a> for more information on the Poetry related files, and
the <a
href="https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html">Conda
environment management documentation</a> for the Conda related
files.</p>
<hr />
<h2 id="getting-started">3  Getting started</h2>
<h3 id="first-time-setup-run-once-after-cloning">3.1 First-time setup
(run once after cloning)</h3>
<h4 id="on-a-cpu-only-laptop-or-ci-runner">On a CPU-only laptop or CI
runner</h4>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create the Conda environment from the CPU config</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> environment-cpu.yml</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Activate the environment</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate docrag-cpu</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Install pure-Python dependencies using Poetry</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> install <span class="at">--with</span> dev</span></code></pre></div>
<h4 id="on-a-gpu-workstation-cuda-12.4">On a GPU workstation (CUDA
12.4)</h4>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Create the Conda environment from the GPU config</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> environment-gpu.yml</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Activate the environment</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate docrag-gpu</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Tell Poetry to install into the active Conda env instead of a .venv</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> config virtualenvs.create false</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Install all pure-Python dependencies</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> install <span class="at">--with</span> dev</span></code></pre></div>
<h3 id="syncing-after-a-git-pull">3.2 Syncing after a
<code>git pull</code></h3>
<p>After pulling from <code>main</code> or another branch, use the
following to make sure your environment is fully up to date.</p>
<h4 id="pure-python-updates-poetry-changes-only">Pure-Python updates
(Poetry changes only)</h4>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Must be in the correct Conda env</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> install <span class="at">--with</span> dev</span></code></pre></div>
<h4 id="compiled-or-cuda-packages-changed-yaml-file-updated">Compiled or
CUDA packages changed (YAML file updated)</h4>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CPU machine</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env update <span class="at">-n</span> docrag-cpu <span class="at">-f</span> environment-cpu.yml <span class="at">--prune</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># GPU machine</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env update <span class="at">-n</span> docrag-gpu <span class="at">-f</span> environment-gpu.yml <span class="at">--prune</span></span></code></pre></div>
<p>Then:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> install <span class="at">--with</span> dev</span></code></pre></div>
<blockquote>
<p>Always re-run <code>poetry install</code> after pulling to apply lock
file changes.</p>
</blockquote>
<hr />
<h2 id="installing-a-new-package">4  Installing a new package</h2>
<ul>
<li><strong>Compiled C/CUDA libraries</strong> (they need a compiler or
specific CUDA minor)  → <strong>Conda</strong>.</li>
<li><strong>Pure‑Python or wheel‑only libraries</strong>
 → <strong>Poetry</strong>.</li>
</ul>
<h3 id="install-with-conda-compiledgpu-lib">4.1  Install <strong>with
Conda</strong> (compiled/GPU lib)</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate docrag-gpu                   <span class="co"># or docrag-cpu</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-c</span> nvidia flash-attn=2.5      <span class="co"># example</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env export <span class="at">--name</span> docrag-gpu <span class="at">--no-builds</span> <span class="op">&gt;</span> environment-gpu.yml</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> add environment-gpu.yml</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">&quot;deps(gpu): add flash‑attn 2.5&quot;</span></span></code></pre></div>
<h3 id="install-with-poetry-purepython-lib">4.2  Install <strong>with
Poetry</strong> (pure‑Python lib)</h3>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate docrag-cpu                   <span class="co"># ensure env active</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add <span class="op">&lt;</span>package-name<span class="op">&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> lock <span class="at">--no-update</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> add pyproject.toml poetry.lock</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">&quot;feat: add typer CLI helper&quot;</span></span></code></pre></div>
<blockquote>
<p>Installing the latest version of a package may not always be
compatible use <code>&lt;package-name&gt;@&lt;version&gt;</code> for
more control.</p>
</blockquote>
<hr />
<h2 id="examples-of-common-packages-and-how-to-install-them">5  Examples
of common packages and how to install them</h2>
<table style="width:100%;">
<colgroup>
<col style="width: 10%" />
<col style="width: 69%" />
<col style="width: 19%" />
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Package examples</th>
<th>Install via</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Heavy GPU ML</td>
<td>torch, torchvision, pytorch‑cuda, faiss‑gpu‑cuVS, flash‑attention,
bitsandbytes</td>
<td><strong>Conda</strong></td>
</tr>
<tr class="even">
<td>CPU math</td>
<td>numpy, scipy, scikit‑learn, pandas</td>
<td>Conda preferred (perf)</td>
</tr>
<tr class="odd">
<td>Text / NLP</td>
<td>transformers, datasets, peft, accelerate</td>
<td><strong>Poetry</strong></td>
</tr>
<tr class="even">
<td>Web / CLI</td>
<td>fastapi, uvicorn, typer, rich</td>
<td><strong>Poetry</strong></td>
</tr>
<tr class="odd">
<td>Dev tools</td>
<td>pytest, ruff, black, mypy, pre‑commit</td>
<td><strong>Poetry</strong> (dev group)</td>
</tr>
</tbody>
</table>
